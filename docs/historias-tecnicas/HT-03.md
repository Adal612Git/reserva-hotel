# HT-03: Implementar JWT con middleware de protecciÃ³n por rol

---

## ğŸ§‘â€ğŸ’» Historia TÃ©cnica

**Como** desarrollador backend,  
**quiero** implementar autenticaciÃ³n mediante JWT y middleware que valide los roles de los usuarios,  
**para** proteger rutas sensibles y permitir acceso controlado a recursos segÃºn el tipo de usuario (cliente, recepcionista, administrador).

---

## ğŸ“Œ Estatus  
âœ… Pendiente de desarrollo

---

## ğŸ¯ PriorizaciÃ³n  
AltÃ­sima â€” Sin esto, el sistema queda inseguro y no puede diferenciar accesos por rol.

---

## ğŸ‘¥ Actor TÃ©cnico Principal  
Equipo backend

---

## ğŸ”— RelaciÃ³n con otras historias tÃ©cnicas y funcionales

- **HT-02**: Estructura del backend  
- **HT-04**: ConexiÃ³n frontend-backend con token en headers  
- **HT-05**: Interceptor en Angular  
- **HU-02**: Login de cliente (emisiÃ³n de token)  
- **HU-10**: Cambio de rol  
- **CU-12**: Diagrama de flujo tÃ©cnico de validaciÃ³n JWT

---

## ğŸ§± Requisitos Previos

- Usuarios registrados en base de datos con credenciales encriptadas (`bcrypt`)  
- Roles asignados a cada usuario (`cliente`, `recepcionista`, `admin`)  
- Variable de entorno `JWT_SECRET` definida en `.env`  
- Middleware y estructura general del backend ya configurados

---

## âœ… Criterios de AceptaciÃ³n

### ğŸ¯ Criterio 1: GeneraciÃ³n de token en login
- [ ] Al iniciar sesiÃ³n correctamente, el backend debe firmar un token JWT que contenga:
  - `id` del usuario
  - `rol`
  - `exp` (expiraciÃ³n)
- [ ] El token debe tener firma segura (HS256) con clave secreta

### ğŸ¯ Criterio 2: Middleware de validaciÃ³n JWT
- [ ] Todas las rutas protegidas deben incluir un middleware que:
  - Verifique la validez del token
  - Rechace accesos sin token o con token invÃ¡lido
  - Extraiga la informaciÃ³n del usuario y la adjunte a `req.user`

### ğŸ¯ Criterio 3: Middleware de validaciÃ³n de rol
- [ ] Debe existir un middleware reutilizable para validar roles:
  - Solo clientes pueden crear reservas
  - Solo recepcionistas pueden ver reservas del dÃ­a
  - Solo administradores pueden cambiar roles o crear habitaciones
- [ ] Las rutas deben declarar el rol permitido al inicio

### ğŸ¯ Criterio 4: Errores claros y seguros
- [ ] Si el token es invÃ¡lido o no existe:
  - Retornar 401 Unauthorized
- [ ] Si el rol no es suficiente:
  - Retornar 403 Forbidden

---

## ğŸ”„ Flujo BÃ¡sico

1. Cliente hace login con correo y contraseÃ±a
2. Backend verifica credenciales y genera JWT
3. El frontend guarda el token (localStorage/sessionStorage)
4. Para cualquier llamada autenticada, el frontend incluye:
