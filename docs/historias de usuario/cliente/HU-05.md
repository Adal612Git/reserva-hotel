# HU-05: Cancelar una reserva

---

## ğŸ“ Historia de Usuario

**Como** cliente autenticado,  
**quiero** poder cancelar una reserva activa desde la secciÃ³n â€œMis Reservasâ€,  
**para** liberar la habitaciÃ³n y evitar cargos en caso de que ya no pueda hospedarme.

---

## ğŸ“Œ Estatus  
âœ… Pendiente de desarrollo

---

## ğŸ¯ PriorizaciÃ³n  
Media-Alta â€” Es esencial para la gestiÃ³n de reservas, mejora la experiencia del cliente y la disponibilidad del sistema.

---

## ğŸ‘¤ Actor Principal  
Cliente (usuario autenticado con token vÃ¡lido)

---

## ğŸ”— RelaciÃ³n con otras historias de usuario

- **HU-01**: Registro de Cliente  
- **HU-02**: Login de Cliente  
- **HU-03**: Crear nueva reserva  
- **HU-04**: Ver mis reservas  
- **HU-12**: ConfirmaciÃ³n por correo o notificaciÃ³n al cancelar  
- **HT-03**: Middleware por rol  
- **HT-08**: Swagger (documentaciÃ³n del endpoint de cancelaciÃ³n)

---

## ğŸ§± Requisitos Previos / Dependencias TÃ©cnicas

- Listado de reservas filtradas por cliente (HU-04)
- Middleware que verifique autenticaciÃ³n del cliente
- Endpoint `DELETE /api/reservas/:id` o `PUT /api/reservas/:id/cancelar`
- ValidaciÃ³n en backend de que:
  - La reserva pertenece al cliente que la solicita
  - La reserva estÃ¡ activa (no finalizada ni ya cancelada)
- EnvÃ­o opcional de confirmaciÃ³n por correo (HU-12)

---

## âœ… Criterios de AceptaciÃ³n

### ğŸ¯ Criterio 1: Acceso restringido
- [ ] Solo usuarios autenticados pueden cancelar una reserva.
- [ ] Solo se permite cancelar **reservas activas** y **antes de la fecha de check-in**.

### ğŸ¯ Criterio 2: ConfirmaciÃ³n visual
- [ ] El sistema debe pedir confirmaciÃ³n antes de cancelar:
  - â€œÂ¿EstÃ¡s seguro que deseas cancelar esta reserva?â€
- [ ] Debe mostrar un mensaje claro al finalizar:  
  > â€œReserva cancelada exitosamenteâ€

### ğŸ¯ Criterio 3: Cambio de estado
- [ ] El estado de la reserva debe actualizarse a `cancelada`.
- [ ] La habitaciÃ³n asociada debe liberarse para permitir nuevas reservas en esas fechas.

### ğŸ¯ Criterio 4: Registro de cancelaciÃ³n
- [ ] Se debe guardar en base de datos la fecha de cancelaciÃ³n.
- [ ] (Opcional futuro) Registrar el motivo si se habilita campo.

### ğŸ¯ Criterio 5: NotificaciÃ³n
- [ ] (Opcional inicial) Enviar confirmaciÃ³n por correo o notificaciÃ³n en el sistema.

---

## ğŸ”„ Flujo BÃ¡sico

1. Cliente inicia sesiÃ³n y accede a â€œMis Reservasâ€ (HU-04).
2. Elige una reserva activa futura y da clic en â€œCancelarâ€.
3. El sistema muestra un mensaje de confirmaciÃ³n.
4. Al aceptar:
   - Se envÃ­a peticiÃ³n `PUT /api/reservas/456/cancelar`
   - El backend:
     - Verifica que la reserva existe y pertenece al cliente
     - Verifica que estÃ© activa y no haya iniciado
     - Cambia el estado a `cancelada`
     - Registra la fecha de cancelaciÃ³n
5. El frontend actualiza la vista y muestra mensaje de Ã©xito.

---

## ğŸ“‰ Flujos Alternativos

### âŒ CancelaciÃ³n no permitida
- Si la reserva ya iniciÃ³ o terminÃ³:
  - Mostrar mensaje:  
    > â€œEsta reserva ya no puede cancelarseâ€

### âŒ Reserva no encontrada
- Si el ID de la reserva no existe o no pertenece al cliente:
  - Mostrar: â€œNo se encontrÃ³ esta reservaâ€ o error 403

### âŒ Error de conexiÃ³n
- Mostrar: â€œNo se pudo cancelar la reserva. Intenta nuevamente mÃ¡s tarde.â€

---

## ğŸ”’ Validaciones de Seguridad

- ValidaciÃ³n JWT con middleware
- VerificaciÃ³n de propiedad (`cliente_id === token.user.id`)
- Bloqueo de cancelaciÃ³n si:
  - Estado ya es `cancelada`
  - Fecha actual â‰¥ `fecha_inicio`

---

## ğŸ§ª Escenarios de prueba

### âœ”ï¸ CancelaciÃ³n vÃ¡lida
```gherkin
Dado que el cliente tiene una reserva activa
Y la fecha de check-in aÃºn no ha llegado
Cuando accede a "Mis Reservas" y confirma la cancelaciÃ³n
Entonces la reserva se actualiza a estado cancelado y se muestra un mensaje de Ã©xito
