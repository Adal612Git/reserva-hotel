# HU-03: Crear nueva reserva

---

## ğŸ“ Historia de Usuario

**Como** cliente autenticado,  
**quiero** poder crear una nueva reserva seleccionando fechas, habitaciÃ³n y nÃºmero de personas,  
**para** asegurar mi lugar en el hotel y poder acceder a los servicios ofrecidos durante mi estadÃ­a.

---

## ğŸ“Œ Estatus  
âœ… Pendiente de desarrollo

---

## ğŸ¯ PriorizaciÃ³n  
Alta â€” Es la funcionalidad central del sistema. Sin ella, el sistema no cumple su propÃ³sito principal.

---

## ğŸ‘¤ Actor Principal  
Cliente (usuario autenticado con token vÃ¡lido)

---

## ğŸ”— RelaciÃ³n con otras historias de usuario

- **HU-01**: Registro de Cliente  
- **HU-02**: Login de Cliente  
- **HU-04**: Ver mis reservas  
- **HU-05**: Cancelar una reserva  
- **HU-06**: Ver habitaciones disponibles  
- **HU-12**: ConfirmaciÃ³n por correo o notificaciÃ³n al crear una reserva  
- **HU-13**: Ver detalle completo de una habitaciÃ³n

---

## ğŸ§± Requisitos Previos / Dependencias TÃ©cnicas

- Sistema de autenticaciÃ³n JWT activo (HT-03, HT-04, HT-05)
- Listado de habitaciones con disponibilidad filtrada por fecha (HU-06)
- Validaciones de fechas (no elegir fechas pasadas o de disponibilidad nula)
- Base de datos con tabla de reservas (`reservas`) relacionada con usuarios y habitaciones
- RelaciÃ³n `cliente â†’ reservas` y `reserva â†’ habitaciÃ³n`
- Endpoint `/api/reservas` con mÃ©todo `POST` funcionando en backend
- Frontend con formulario interactivo para nueva reserva

---

## âœ… Criterios de AceptaciÃ³n

### ğŸ¯ Criterio 1: Formulario funcional
- [ ] El formulario debe tener campos:
  - Fecha de entrada (check-in)
  - Fecha de salida (check-out)
  - NÃºmero de personas
  - HabitaciÃ³n (seleccionada de las disponibles)
- [ ] Solo se permiten fechas actuales o futuras (no pasadas).
- [ ] El nÃºmero de personas no puede exceder la capacidad de la habitaciÃ³n.

### ğŸ¯ Criterio 2: ValidaciÃ³n de disponibilidad
- [ ] Solo se muestran habitaciones disponibles para el rango de fechas seleccionado.
- [ ] Si al enviar la reserva ya no estÃ¡ disponible, se debe notificar al usuario.

### ğŸ¯ Criterio 3: Registro exitoso
- [ ] Al enviar el formulario correctamente, se debe crear la reserva en la base de datos.
- [ ] El backend debe asociar la reserva al ID del cliente autenticado (usando el token).
- [ ] Se debe mostrar un mensaje de confirmaciÃ³n clara.

### ğŸ¯ Criterio 4: NotificaciÃ³n
- [ ] (Opcional inicial, obligatorio en futuro) Se debe enviar una confirmaciÃ³n por correo o mostrar una notificaciÃ³n en pantalla.

### ğŸ¯ Criterio 5: Seguridad
- [ ] Solo usuarios autenticados pueden acceder al formulario de reserva.
- [ ] El ID del cliente se toma desde el token (no debe ser enviado desde el frontend).
- [ ] Validar que la habitaciÃ³n seleccionada pertenezca a la base del hotel (no permitir IDs falsificados).

---

## ğŸ”„ Flujo BÃ¡sico del Cliente

1. Cliente inicia sesiÃ³n y accede a la secciÃ³n â€œNueva Reservaâ€.
2. El sistema carga:
   - Habitaciones disponibles segÃºn fechas ingresadas.
   - Capacidad de cada habitaciÃ³n.
3. El cliente llena el formulario:
   - Check-in: 15 abril 2025
   - Check-out: 18 abril 2025
   - 2 personas
   - HabitaciÃ³n 203
4. Al hacer clic en â€œReservarâ€:
   - El sistema valida los campos.
   - El backend verifica disponibilidad final.
   - Se guarda la reserva con el ID del cliente autenticado.
5. El cliente recibe:
   - Un mensaje de Ã©xito.
   - (Opcional) Una notificaciÃ³n o correo de confirmaciÃ³n.
6. RedirecciÃ³n opcional a â€œMis Reservasâ€.

---

## ğŸ“‰ Flujos Alternativos

### âŒ Habitaciones no disponibles
- Si el cliente selecciona fechas pero no hay habitaciones disponibles, el sistema debe mostrar un mensaje claro:  
  `"No hay habitaciones disponibles para ese rango de fechas"`

### âŒ Intento de reservar sin sesiÃ³n activa
- El sistema debe redirigir al login o mostrar un mensaje:  
  `"Debes iniciar sesiÃ³n para hacer una reserva"`

### âŒ ValidaciÃ³n de fechas incorrectas
- Si `check-out` es antes de `check-in`, el formulario debe evitar el envÃ­o.
- Si se selecciona una fecha pasada, debe rechazarse inmediatamente.

---

## ğŸ”’ Validaciones de Seguridad

- ValidaciÃ³n en backend del token JWT (middleware por rol cliente)
- ValidaciÃ³n de fechas en backend (seguridad adicional al frontend)
- El ID del cliente se extrae del token (nunca del frontend)
- PrevenciÃ³n de reservas dobles en el mismo rango con control de concurrencia
- PrevenciÃ³n de inyecciÃ³n en IDs de habitaciÃ³n

---

## ğŸ§ª Escenarios de prueba

### âœ”ï¸ Reserva vÃ¡lida
```gherkin
Dado que el cliente estÃ¡ autenticado
Y selecciona fechas con disponibilidad
Cuando envÃ­a el formulario correctamente
Entonces la reserva se crea y se muestra un mensaje de Ã©xito
